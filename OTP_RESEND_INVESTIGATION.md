# OTP Resend Investigation Report

**Date:** 2026-02-16  
**Investigation Status:** Complete  
**Requested by:** Repository Owner

---

## Executive Summary

This investigation examined the OTP (One-Time Password) resend functionality for unverified users in the Nivasity platform. **We confirmed that multiple OTP resend mechanisms exist**, including both user-initiated and admin-initiated flows.

---

## Key Findings

### 1. **User-Initiated OTP Resend** ✅
**File:** `/API/auth/resend-otp.php`

**Purpose:** Allows unverified users to request a new verification OTP via API endpoint.

**How it works:**
- Accepts POST requests with user's email
- Validates that the user exists and has `status = 'unverified'`
- Prevents already verified users from resending OTP
- Generates a new 6-digit OTP with 10-minute expiration
- Sends OTP via email using Brevo mail service
- Returns success/error response

**Security Features:**
- Validates user exists before sending
- Checks user status (must be 'unverified')
- Prevents resending to verified accounts
- Deletes any existing OTPs before creating new one
- Sets expiration time (10 minutes)

**API Endpoint:** `/API/auth/resend-otp.php`

**Request Format:**
```json
{
  "email": "user@example.com"
}
```

---

### 2. **Admin Bulk Resend** ✅
**File:** `/admin/resend_pending_verifications.php`

**Purpose:** Allows authorized administrators to bulk resend verification emails to ALL unverified users.

**How it works:**
- Restricted to 3 specific email addresses (hardcoded authorization):
  - `akinyemisamuel170@gmail.com`
  - `samuel@nivasity.com`
  - `blessing.cf@nivasity.com`
- Queries database for all users with `status = 'unverified'`
- Generates 12-character verification codes (NOT OTP format)
- Sends verification links (not OTP codes) based on user role:
  - `org_admin` → `setup_org.html?verify={code}`
  - `visitor` → `verify.html?verify={code}`
  - Default → `setup.html?verify={code}`
- Displays HTML summary page with results

**Security Features:**
- Access restricted to 3 authorized admin emails
- Requires active session (`$_SESSION['nivas_userId']`)
- Uses verification links instead of OTP codes
- Sets no expiration (`exp_date = NULL`)

**Access:** Direct URL access by authorized admins only (not linked in UI navigation)

---

### 3. **Initial Registration Flow** ✅
**File:** `/API/auth/register.php`

- Creates user with `status = 'unverified'`
- Automatically generates and sends 6-digit OTP (10-minute expiration)
- Uses same OTP format as resend endpoint

---

### 4. **OTP Verification** ✅
**File:** `/API/auth/verify-otp.php`

- Validates OTP against user_id and expiration
- Updates user status from 'unverified' to 'verified'
- Generates JWT tokens upon successful verification
- Deletes used OTP from database

---

## Comparison: Two Different Verification Systems

| Feature | API OTP System | Admin Link System |
|---------|----------------|-------------------|
| **Code Format** | 6-digit numeric OTP | 12-character alphanumeric |
| **Delivery** | Email with OTP code | Email with clickable link |
| **Expiration** | 10 minutes | None (NULL) |
| **Verification Method** | Manual OTP entry via API | Click verification link |
| **Who Can Trigger** | User themselves | Authorized admins only |
| **Target Users** | Individual user | All unverified users (bulk) |
| **Use Case** | Modern API-based flow | Legacy/bulk verification |

---

## Security Considerations

### ✅ **Good Security Practices:**
1. OTPs have reasonable expiration time (10 minutes)
2. Users must be 'unverified' to receive new OTP
3. Verified accounts cannot request resend (prevents abuse)
4. Old OTPs are deleted before generating new ones
5. Admin bulk resend is restricted to specific emails
6. Session validation required for admin access

### ⚠️ **Potential Concerns:**
1. **Admin verification codes have NO expiration** - codes generated by admin bulk resend never expire (`exp_date = NULL`)
2. **Hardcoded admin emails** - authorization list is hardcoded in PHP file
3. **No rate limiting visible** - no apparent throttling on OTP resend requests
4. **Two parallel verification systems** - OTP-based and link-based systems coexist, which may cause confusion

---

## Database Schema (Inferred)

**`users` table:**
- `id` - user identifier
- `email` - user email address
- `status` - user status ('unverified', 'verified', etc.)
- `first_name`, `last_name` - user names
- `role` - user role ('student', 'org_admin', 'visitor', etc.)

**`verification_code` table:**
- `user_id` - foreign key to users.id
- `code` - verification code (6-digit OTP or 12-char string)
- `exp_date` - expiration timestamp (NULLABLE)

---

## Recommendations

### Priority 1: Security Improvements
1. **Add expiration to admin-generated codes:** Set reasonable expiration (e.g., 24-48 hours) instead of NULL
2. **Implement rate limiting:** Prevent OTP spam by limiting resend frequency (e.g., max 3 requests per hour)
3. **Move admin emails to config:** Store authorized admin emails in database or config file, not hardcoded

### Priority 2: User Experience
4. **Consolidate verification systems:** Consider migrating all users to OTP-based system for consistency
5. **Add UI link for resend:** Make resend OTP functionality more discoverable in the UI
6. **Improve error messages:** Provide clearer feedback about why resend might fail

### Priority 3: Monitoring & Logging
7. **Log resend attempts:** Track OTP resend requests for security monitoring
8. **Alert on bulk operations:** Notify when admin bulk resend is used
9. **Monitor verification completion rates:** Track how many users successfully verify

---

## Conclusion

**Yes, there are files/code that resend OTP to unverified users.** Specifically:

1. **`/API/auth/resend-otp.php`** - User-initiated OTP resend (modern API approach)
2. **`/admin/resend_pending_verifications.php`** - Admin bulk verification resend (legacy link-based approach)

Both mechanisms are working as intended but could benefit from the security improvements listed above, particularly:
- Adding expiration to admin-generated verification codes
- Implementing rate limiting on user-initiated resends
- Removing hardcoded admin authorization lists

The system appears functional but has two parallel verification flows that may need consolidation for better maintainability.

---

## Files Reviewed

- `/API/auth/resend-otp.php` - User OTP resend endpoint
- `/API/auth/register.php` - Initial registration with OTP
- `/API/auth/verify-otp.php` - OTP verification endpoint
- `/admin/resend_pending_verifications.php` - Admin bulk resend
- `/model/mail.php` - Email sending functionality
- `/model/functions.php` - Helper functions
- `/config/fw.php` - Framework functions
- `/API/config.php` - API configuration

---

**Investigator:** GitHub Copilot  
**Report Generated:** 2026-02-16
